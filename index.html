<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Application de Pointage d'Heure</title>
    
    <!-- M√©ta-donn√©es pour PWA (Progressive Web App) -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pointage">
    <meta name="application-name" content="Pointage">
    <meta name="theme-color" content="#2563eb">

    <!-- Placeholders pour les ic√¥nes -->
    <link rel="icon" type="image/png" id="dynamic-favicon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üïí</text></svg>">
    <link rel="apple-touch-icon" id="dynamic-apple-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üïí</text></svg>">
    <link rel="manifest" id="dynamic-manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Utilisation de xlsx-js-style pour le style Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, limit, getDocs, deleteDoc, orderBy, serverTimestamp, getDoc, Timestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            addDoc,
            setDoc,
            updateDoc,
            onSnapshot,
            collection,
            query,
            where,
            limit,
            getDocs,
            deleteDoc,
            orderBy,
            serverTimestamp,
            getDoc,
            Timestamp,
            enableIndexedDbPersistence
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
            touch-action: manipulation; 
            overscroll-behavior-y: none;
        }
        .container-card {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05), 0 0 10px rgba(0, 0, 0, 0.03);
            background-color: white;
        }
        .btn-primary {
            transition: all 0.2s;
        }
        .btn-primary:active {
            transform: scale(0.98);
        }
        .input-4-digit {
            letter-spacing: 0.5rem;
            text-align: center;
            font-family: monospace;
        }
        
        /* SCROLL WHEEL STYLES */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .wheel-container {
            position: relative;
            height: 160px;
            overflow: hidden;
            background: #ffffff; /* White bg for clean look */
            border-radius: 0 0 0.75rem 0.75rem; /* Rounded bottom only */
            /* Border handled by parent now */
        }
        .wheel-highlight {
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 50px;
            margin-top: -25px;
            background-color: #f3f4f6;
            border-top: 2px solid #e5e7eb;
            border-bottom: 2px solid #e5e7eb;
            border-radius: 8px;
            pointer-events: none;
            z-index: 0;
        }
        .wheel-column {
            height: 100%;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            padding-top: 55px; 
            padding-bottom: 55px;
            position: relative;
            z-index: 10;
        }
        .wheel-item {
            height: 50px; /* Bigger items */
            display: flex;
            align-items: center;
            justify-content: center;
            scroll-snap-align: center;
            font-size: 1.8rem; /* Bigger font */
            font-weight: 700;
            color: #94a3b8;
            transition: all 0.2s;
        }
        
        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .numpad-btn {
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            height: 60px;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: background-color 0.15s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .numpad-btn:active {
            background-color: #f1f5f9;
            transform: scale(0.95);
        }
        .numpad-btn.action-btn {
            background-color: #eff6ff;
            color: #2563eb;
            border-color: #bfdbfe;
        }
        .numpad-btn.clear-btn {
            background-color: #fef2f2;
            color: #dc2626;
            border-color: #fecaca;
        }
        
        /* Toast notification */
        #toast-notification {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast-notification.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
        
        /* Logo Upload Styles */
        .logo-container {
            position: relative;
            cursor: pointer;
            display: inline-block;
        }
        .logo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
        }
        .logo-container:hover .logo-overlay {
            opacity: 1;
        }
        
        /* Loading spinner for logo */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Success Animation */
        @keyframes progress { from { width: 100%; } to { width: 0%; } }
        .progress-bar { animation: progress 5s linear forwards; }
        
        /* Table Preview Styles */
        .preview-header { 
            background-color: #FFC000; 
            font-weight: bold; 
            text-align: center; 
            font-size: 0.85rem;
            border: 1px solid #94a3b8;
            padding: 12px 6px;
            color: #0f172a;
            white-space: nowrap;
        }
        .preview-cell { 
            text-align: center; 
            font-size: 0.95rem;
            border: 1px solid #cbd5e1; 
            padding: 12px 6px;
            color: #334155;
            white-space: nowrap;
        }
        .preview-week-row { 
            background-color: #FFFF00; 
            font-weight: bold; 
            color: #DC2626; 
            text-align: center;
            font-size: 0.9rem;
            padding: 8px;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex flex-col items-center">

    <!-- Auth / App Info -->
    <div id="auth-info" class="mb-4 text-xs text-gray-500 w-full max-w-4xl text-center">
        Statut: <span id="connection-status" class="font-bold text-orange-500">D√©marrage...</span>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="w-full max-w-4xl container-card rounded-xl p-6 md:p-10 relative">
        <div id="error-banner-container"></div>

        <div class="flex flex-col items-center justify-center mb-6">
            <!-- Hidden File Input for Logo -->
            <input type="file" id="logo-upload-input" accept="image/*" class="hidden" onchange="handleLogoUpload(this)">
            
            <!-- Logo Image Container with Click-to-Edit -->
            <div class="logo-container mb-4" onclick="document.getElementById('logo-upload-input').click()" title="Cliquez pour changer le logo">
                <img id="app-logo" src="logo.png" 
                     alt="Logo Pointage" 
                     class="h-48 w-auto object-contain rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 hidden">
                
                <!-- Fallback Icon -->
                <div id="fallback-logo-icon" class="bg-blue-50 p-4 rounded-full text-blue-600 border border-blue-100 shadow-sm cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    <div class="text-xs text-center mt-1 font-bold">Ajouter Logo</div>
                </div>
                
                <!-- Loading State -->
                <div id="logo-loading" class="hidden absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center rounded-lg">
                    <div class="loading-spinner"></div>
                </div>

                <div class="logo-overlay"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg></div>
            </div>

            <h1 class="text-3xl font-bold text-gray-800 text-center">Syst√®me de Pointage</h1>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex border-b border-gray-200 mb-8">
            <button id="tab-punch" onclick="showView('punch')" class="flex-1 py-3 text-sm font-medium border-b-2 transition-colors duration-200" data-active-class="border-blue-600 text-blue-600" data-inactive-class="border-transparent text-gray-500 hover:text-gray-700">Pointage Employ√©</button>
            <button id="tab-admin" onclick="requestAdminAccess()" class="flex-1 py-3 text-sm font-medium border-b-2 transition-colors duration-200" data-active-class="border-blue-600 text-blue-600" data-inactive-class="border-transparent text-gray-500 hover:text-gray-700">
                <span class="flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    Administration
                </span>
            </button>
        </div>

        <!-- 1. PUNCH CLOCK INTERFACE -->
        <div id="view-punch" class="view-content">
            <div class="max-w-md mx-auto">
                
                <!-- STEP 1: LOGIN -->
                <div id="step-login" class="p-6 bg-blue-50 rounded-lg shadow-inner mb-8">
                    <p class="text-center text-lg font-medium text-blue-800 mb-4">Entrez votre code</p>
                    <input id="employee-code" type="text" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" readonly class="input-4-digit w-full p-4 text-4xl border-2 border-blue-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500 mb-6 text-gray-800">
                    <div class="numpad-grid select-none">
                        <div onclick="typeNum('employee-code', '1')" class="numpad-btn">1</div>
                        <div onclick="typeNum('employee-code', '2')" class="numpad-btn">2</div>
                        <div onclick="typeNum('employee-code', '3')" class="numpad-btn">3</div>
                        <div onclick="typeNum('employee-code', '4')" class="numpad-btn">4</div>
                        <div onclick="typeNum('employee-code', '5')" class="numpad-btn">5</div>
                        <div onclick="typeNum('employee-code', '6')" class="numpad-btn">6</div>
                        <div onclick="typeNum('employee-code', '7')" class="numpad-btn">7</div>
                        <div onclick="typeNum('employee-code', '8')" class="numpad-btn">8</div>
                        <div onclick="typeNum('employee-code', '9')" class="numpad-btn">9</div>
                        <div onclick="clearNum('employee-code')" class="numpad-btn clear-btn">Effacer</div>
                        <div onclick="typeNum('employee-code', '0')" class="numpad-btn">0</div>
                        <div onclick="verifyCodeAndShowMenu()" class="numpad-btn action-btn bg-blue-600 text-white border-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- STEP 2: EMPLOYEE DASHBOARD -->
                <div id="step-dashboard" class="hidden">
                    <div class="text-center mb-8">
                        <h2 id="dashboard-welcome" class="text-2xl font-bold text-gray-800">Bonjour</h2>
                        <p class="text-sm text-gray-500">Choisissez une action</p>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-6">
                        <button onclick="onMenuPunch()" id="btn-punch-action" class="p-8 rounded-xl shadow-lg border-4 text-left transition-all transform active:scale-95 flex items-center justify-between group">
                            <!-- JS will update class and text here -->
                            <div class="flex items-center">
                                <div id="btn-punch-icon" class="p-4 rounded-full mr-4 bg-gray-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <span id="btn-punch-text" class="block text-2xl font-bold text-gray-800 uppercase tracking-wide">Action</span>
                                    <span id="btn-punch-sub" class="text-sm text-gray-600 font-medium">Statut...</span>
                                </div>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400 group-hover:text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>

                        <button onclick="onMenuHistory()" class="bg-white p-8 rounded-xl shadow-lg border-2 border-blue-100 hover:border-blue-300 text-left transition-all transform active:scale-95 flex items-center justify-between group">
                            <div class="flex items-center">
                                <div class="bg-blue-50 p-4 rounded-full mr-4 text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                <div>
                                    <span class="block text-xl font-bold text-gray-800">Voir mes heures</span>
                                    <span class="text-sm text-gray-500">Historique complet</span>
                                </div>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 group-hover:text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>

                    <button onclick="resetToCodeEntry()" class="w-full mt-8 py-4 text-gray-500 font-bold hover:text-red-600 flex items-center justify-center bg-gray-50 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                        </svg>
                        D√âCONNEXION
                    </button>
                </div>

                <!-- STEP 3: EMPLOYEE HISTORY TABLE -->
                <div id="step-history" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">Historique</h2>
                            <input type="month" id="employee-month-picker" class="mt-1 text-sm p-1 border rounded text-gray-600 shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="renderEmployeeHistory()">
                        </div>
                        <button onclick="document.getElementById('step-history').classList.add('hidden'); document.getElementById('step-dashboard').classList.remove('hidden');" class="text-blue-600 font-bold text-sm bg-blue-50 px-3 py-2 rounded-lg hover:bg-blue-100">
                            Retour
                        </button>
                    </div>
                    <div class="overflow-auto border border-gray-300 rounded-lg shadow-inner bg-white h-[70vh]">
                        <table class="min-w-full border-collapse">
                            <thead class="sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="preview-header">Sem</th>
                                    <th class="preview-header">Date</th>
                                    <th class="preview-header">Arr M</th>
                                    <th class="preview-header">Dep M</th>
                                    <th class="preview-header">Pau M</th>
                                    <th class="preview-header">Tot M</th>
                                    <th class="preview-header">Arr S</th>
                                    <th class="preview-header">Dep S</th>
                                    <th class="preview-header">Pau S</th>
                                    <th class="preview-header">Tot S</th>
                                    <th class="preview-header">Total</th>
                                </tr>
                            </thead>
                            <tbody id="employee-history-body" class="bg-white">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <!-- 2. ADMIN INTERFACE -->
        <div id="view-admin" class="view-content hidden">
             
             <!-- Manual Correction Tool -->
             <div class="mb-10 p-6 bg-white rounded-lg shadow-sm border border-orange-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center text-orange-700">Corrections & Ajout Manuel</h3>
                    <button onclick="openManualPunchModal(null)" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded text-sm font-medium flex items-center">Nouvelle Entr√©e</button>
                </div>
                <div class="flex flex-col md:flex-row gap-4 mb-4 bg-orange-50 p-4 rounded-lg">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Employ√©</label>
                        <select id="admin-correction-employee" class="w-full p-2 border rounded focus:ring-orange-500 focus:border-orange-500" onchange="loadCorrectionData()">
                            <option value="">-- Tous les employ√©s --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Date √† corriger</label>
                        <input type="date" id="admin-correction-date" class="p-2 border rounded focus:ring-orange-500 focus:border-orange-500" onchange="loadCorrectionData()">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Employ√©</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Arriv√©e</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">D√©part</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Pause</th><th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th></tr>
                        </thead>
                        <tbody id="correction-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
            
             <!-- Add Employee Form -->
             <div class="p-6 bg-gray-50 rounded-lg border mb-8">
                <h3 class="text-xl font-medium mb-4 text-gray-700">Ajouter un Nouvel Employ√©</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input id="new-employee-name" type="text" placeholder="Nom de l'employ√©" class="p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input id="new-employee-code" type="text" maxlength="4" placeholder="Code (4 chiffres)" class="p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4)">
                    <button onclick="addEmployee()" class="btn-primary bg-green-600 text-white font-medium py-3 rounded-lg hover:bg-green-700">Ajouter</button>
                </div>
            </div>

            <!-- RESTORED: Employee List -->
            <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Liste des Employ√©s</h3>
            <div id="employee-list-container" class="overflow-x-auto mb-8">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead>
                    <tbody id="employee-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>

            <!-- PREVIEW EXCEL TABLE -->
            <div class="mt-12 mb-10">
                <div class="flex flex-col md:flex-row md:items-end justify-between mb-4 border-b border-gray-200 pb-4 gap-4">
                    <h3 class="text-xl font-semibold text-gray-700">Aper√ßu Tableau Comptable</h3>
                    <div class="flex flex-col sm:flex-row items-center gap-3">
                        <div class="flex items-center bg-gray-50 p-1 rounded-lg border border-gray-200">
                            <span class="text-xs font-bold text-gray-500 uppercase px-2">Mois</span>
                            <input type="month" id="admin-month-picker" class="bg-white border-none text-sm p-1 rounded focus:ring-0 text-gray-700 font-medium h-8" onchange="renderMonthPreview()">
                        </div>
                        <button onclick="exportToExcel()" class="btn-primary bg-green-600 text-white font-bold py-1.5 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center shadow-sm text-sm h-10">Excel</button>
                    </div>
                </div>
                <div id="preview-records-container" class="space-y-8"></div>
                <div class="mt-4 flex justify-end">
                    <button onclick="resetAllPunches()" class="text-red-600 hover:text-red-800 text-sm font-medium flex items-center border border-red-200 bg-red-50 hover:bg-red-100 px-3 py-2 rounded shadow-sm transition-colors">R√©initialiser tout l'historique</button>
                </div>
            </div>
             <!-- Admin Settings -->
             <div class="mt-12 p-6 bg-gray-100 rounded-lg border border-gray-200">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Param√®tres Administrateur</h3>
                <div class="flex items-center space-x-4">
                    <div class="flex-grow max-w-xs">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Code d'acc√®s Admin</label>
                        <input id="setting-admin-code" type="text" maxlength="8" class="w-full p-2 border rounded shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: 1976">
                    </div>
                    <div class="mt-5">
                        <button onclick="saveNewAdminCode()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 font-medium text-sm transition-colors">Enregistrer le nouveau code</button>
                    </div>
                </div>
                <p id="settings-message" class="mt-2 text-sm h-5"></p>
            </div>
        </div>
    </div>

    <!-- NEW: Modal for Manual Time Entry with SCROLL WHEEL AND COLORS -->
    <div id="manual-time-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full transform transition-all scale-100 flex flex-col h-auto overflow-hidden">
            
            <!-- DYNAMIC HEADER -->
            <div id="manual-time-header" class="p-6 text-white text-center shadow-md z-20 relative">
                <h3 id="manual-time-title" class="text-3xl font-extrabold uppercase tracking-wider drop-shadow-sm">ACTION</h3>
                <p id="manual-time-subtitle" class="text-white text-opacity-90 font-medium text-sm mt-1">Veuillez confirmer l'heure</p>
            </div>
            
            <div class="p-6">
                <!-- Date Display -->
                <div class="mb-4 text-center">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Date du pointage</label>
                    <input type="date" id="manual-punch-date" class="w-full p-3 border-b-2 border-gray-200 text-center text-xl font-bold text-gray-700 focus:border-blue-500 outline-none transition-colors bg-transparent">
                </div>

                <!-- iOS STYLE SCROLL PICKER -->
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-2 text-center">S√©lectionnez l'heure</label>
                    <div class="wheel-container border border-gray-200 rounded-xl">
                        <div class="wheel-highlight"></div>
                        <div class="flex justify-center h-full relative z-10">
                            <!-- Hour Wheel -->
                            <div class="w-24 wheel-column no-scrollbar" id="hour-wheel">
                                <!-- Populated by JS -->
                            </div>
                            <div class="flex items-center justify-center font-bold text-3xl text-gray-300 mx-1 z-10 pt-[2px]">:</div>
                            <!-- Minute Wheel (Quarter Hours) -->
                            <div class="w-24 wheel-column no-scrollbar" id="minute-wheel">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                    <button id="btn-set-now" onclick="setManualToNow()" class="w-full py-3 mt-4 text-sm font-bold uppercase tracking-wide rounded-lg transition-colors border-2">
                        Heure Actuelle (Arrondie)
                    </button>
                </div>

                <div class="flex space-x-3 mt-4">
                    <button onclick="closeManualTimeModal()" class="flex-1 py-4 border border-gray-300 rounded-lg text-gray-500 font-bold hover:bg-gray-50 transition-colors">ANNULER</button>
                    <button id="btn-confirm-time" onclick="confirmManualPunch()" class="flex-1 py-4 text-white rounded-lg font-bold shadow-lg transform active:scale-95 transition-all text-lg">VALIDER</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- BREAK SELECTION MODAL (5 MINUTE INCREMENTS) -->
    <div id="break-selection-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full transform transition-all scale-100 flex flex-col overflow-hidden animate-bounce-in">
            <div class="bg-orange-500 p-6 text-white text-center shadow-md">
                <h3 class="text-2xl font-bold uppercase tracking-wide">TEMPS DE PAUSE ?</h3>
                <p class="text-white text-opacity-90 text-xs mt-1">Avez-vous pris une pause aujourd'hui ?</p>
            </div>
            
            <div class="p-8">
                <div class="flex items-center justify-center mb-8 select-none">
                    <!-- CHANGED TO 5 MIN INCREMENTS -->
                    <button onclick="adjustBreakRed(-5)" class="p-4 bg-gray-100 rounded-l-xl hover:bg-gray-200 border border-gray-200 font-bold text-gray-600 w-16 text-xl transition-colors">-</button>
                    <input type="number" id="red-punch-break" value="0" step="5" min="0" class="w-28 p-4 bg-white text-gray-800 border-y border-gray-200 text-center text-4xl font-bold focus:outline-none focus:border-blue-500">
                    <button onclick="adjustBreakRed(5)" class="p-4 bg-gray-100 rounded-r-xl hover:bg-gray-200 border border-gray-200 font-bold text-gray-600 w-16 text-xl transition-colors">+</button>
                </div>
                <p class="text-center text-gray-400 text-xs mb-6 italic">Incr√©ments de 5 minutes</p>

                <div class="flex space-x-3">
                    <button onclick="document.getElementById('break-selection-modal').classList.add('hidden'); document.getElementById('break-selection-modal').classList.remove('flex');" class="flex-1 py-4 border border-gray-300 rounded-lg text-gray-600 font-bold hover:bg-gray-50 transition-colors">RETOUR</button>
                    <button onclick="confirmBreak()" class="flex-1 py-4 bg-orange-600 text-white rounded-lg font-bold shadow-lg hover:bg-orange-700 transition-colors">TERMINER</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PUNCH SUCCESS MODAL -->
    <div id="punch-success-modal" onclick="if(event.target === this) closeSuccessModal()" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 backdrop-blur-md cursor-pointer">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center relative overflow-hidden transform transition-all scale-105 cursor-default">
            <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-green-100 mb-6">
                <svg class="h-10 w-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">C'est not√© !</h3>
            <p id="punch-success-message" class="text-lg text-gray-600 font-medium mb-6">Message de confirmation</p>
            <button onclick="undoLastPunch()" class="w-full py-3 mb-4 bg-red-50 text-red-600 border border-red-100 rounded-lg font-bold text-sm hover:bg-red-100 flex items-center justify-center transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                Oups, je me suis tromp√© (Annuler)
            </button>
            <div class="w-full bg-gray-200 rounded-full h-1.5 mb-1"><div id="punch-progress-bar" class="bg-green-600 h-1.5 rounded-full" style="width: 100%"></div></div>
        </div>
    </div>

    <!-- Admin/Manual Correction Modals (Restored & Updated) -->
    <div id="manual-correction-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full">
            <h3 class="text-xl font-bold mb-4 text-gray-800" id="correction-modal-title">Modifier / Ajouter</h3>
            <input type="hidden" id="edit-punch-id">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Employ√©</label>
                    <select id="edit-punch-employee" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="edit-punch-date" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Heure Arriv√©e</label>
                        <input type="time" id="edit-punch-in" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Heure D√©part</label>
                        <input type="time" id="edit-punch-out" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Pause (minutes)</label>
                    <input type="number" id="edit-punch-break" min="0" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="document.getElementById('manual-correction-modal').classList.add('hidden'); document.getElementById('manual-correction-modal').classList.remove('flex')" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200">Annuler</button>
                <button onclick="saveManualPunch()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Enregistrer</button>
            </div>
        </div>
    </div>
    
    <div id="admin-login-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 backdrop-blur-sm"><div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full transform transition-all scale-100 flex flex-col h-auto max-h-screen overflow-y-auto" id="admin-modal-content"><div class="text-center mb-4"><div class="mx-auto bg-gray-100 w-12 h-12 rounded-full flex items-center justify-center mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg></div><h3 class="text-xl font-bold text-gray-800">Acc√®s Admin</h3></div><input id="admin-login-input" type="password" maxlength="8" readonly class="w-full p-3 border-2 border-gray-300 rounded-lg text-2xl text-center focus:border-blue-500 focus:outline-none mb-4 tracking-widest bg-white" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"><div class="numpad-grid select-none mb-4"><div onclick="typeNum('admin-login-input', '1')" class="numpad-btn">1</div><div onclick="typeNum('admin-login-input', '2')" class="numpad-btn">2</div><div onclick="typeNum('admin-login-input', '3')" class="numpad-btn">3</div><div onclick="typeNum('admin-login-input', '4')" class="numpad-btn">4</div><div onclick="typeNum('admin-login-input', '5')" class="numpad-btn">5</div><div onclick="typeNum('admin-login-input', '6')" class="numpad-btn">6</div><div onclick="typeNum('admin-login-input', '7')" class="numpad-btn">7</div><div onclick="typeNum('admin-login-input', '8')" class="numpad-btn">8</div><div onclick="typeNum('admin-login-input', '9')" class="numpad-btn">9</div><div onclick="clearNum('admin-login-input')" class="numpad-btn clear-btn">C</div><div onclick="typeNum('admin-login-input', '0')" class="numpad-btn">0</div><div onclick="verifyAdminCode()" class="numpad-btn action-btn">OK</div></div><button onclick="closeAdminModal()" class="w-full text-gray-500 font-medium py-2 hover:text-gray-700 border rounded-lg">Annuler</button><p id="admin-login-error" class="text-center mt-2 text-sm font-medium text-red-500 h-5"></p></div></div>
    
    <div id="toast-notification">Notification</div>

    <script type="module">
        // ... (Imports remain the same) ...
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, limit, getDocs, deleteDoc, orderBy, serverTimestamp, getDoc, Timestamp, enableIndexedDbPersistence } = window.firebase;

        let config = {};
        try { config = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'); } catch(e) {}
        if (Object.keys(config).length === 0) { config = { apiKey: "AIzaSyAxG6D6yQWSUR3K2JORaXajA5QaCDp376A", authDomain: "pointage-5b928.firebaseapp.com", projectId: "pointage-5b928", storageBucket: "pointage-5b928.firebasestorage.app", messagingSenderId: "604304798014", appId: "1:604304798014:web:ac29f9638934bfdedbbc6f" }; }
        const firebaseConfig = config;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pointage-app';

        let app, db, auth, userId = null;
        let employees = []; 
        let punches = []; 
        let isAuthReady = false;
        let currentAdminCode = "1976"; 
        let currentEmployee = null;
        let lastCreatedPunchId = null;
        
        const getColRef = (colName) => collection(db, 'artifacts', appId, 'public', 'data', colName);
        const getDocRef = (colName, docId) => doc(db, 'artifacts', appId, 'public', 'data', colName, docId);

        // Helper date utils
        function formatDuration(ms) {
            if (ms === undefined || ms === null) return 'N/A';
            const totalSeconds = Math.floor(Math.abs(ms) / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${hours}h ${String(minutes).padStart(2,'0')}`;
        }
        function getLocalDateInputValue(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // --- CORE FUNCTIONS (Toast, Numpad, Auth) ---
        window.showToast = (message) => {
            const toast = document.getElementById("toast-notification");
            toast.textContent = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }
        window.typeNum = (inputId, num) => {
            const input = document.getElementById(inputId);
            if (input && input.value.length < input.maxLength) {
                input.value += num;
                input.dispatchEvent(new Event('input'));
            }
        };
        window.clearNum = (inputId) => { const input = document.getElementById(inputId); if(input) input.value = ''; };

        // --- SUCCESS MODAL ---
        window.closeSuccessModal = () => {
            const modal = document.getElementById('punch-success-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            if (window.successModalTimer) clearTimeout(window.successModalTimer);
        };

        window.showSuccessModal = (message, punchId) => {
            const modal = document.getElementById('punch-success-modal');
            document.getElementById('punch-success-message').textContent = message;
            lastCreatedPunchId = punchId;
            const bar = document.getElementById('punch-progress-bar');
            bar.classList.remove('progress-bar');
            void bar.offsetWidth; 
            bar.classList.add('progress-bar');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            if (window.successModalTimer) clearTimeout(window.successModalTimer);
            window.successModalTimer = setTimeout(() => closeSuccessModal(), 5000);
        }

        // --- UNDO ---
        window.undoLastPunch = async () => {
            if (!lastCreatedPunchId) return;
            try {
                const docRef = getDocRef('punches', lastCreatedPunchId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.punchOutTime) {
                        await updateDoc(docRef, { punchOutTime: null, breakDuration: 0 });
                        showToast("D√©part annul√©. Vous √™tes toujours point√©.");
                    } else {
                        await deleteDoc(docRef);
                        showToast("Arriv√©e annul√©e.");
                    }
                }
                document.getElementById('punch-success-modal').classList.add('hidden');
                document.getElementById('punch-success-modal').classList.remove('flex');
                if (currentEmployee) verifyCodeAndShowMenu(); else resetToCodeEntry();
            } catch (e) { console.error(e); }
        };

        // --- INITIALIZATION ---
        window.onload = async () => {
            // Populate Scroll Wheels (NEW Logic)
            populateWheels();

            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) { document.getElementById('connection-status').textContent = "‚ö†Ô∏è CONFIGURATION MANQUANTE"; return; }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                try { await enableIndexedDbPersistence(db); } catch (err) {}

                document.getElementById('connection-status').textContent = "Connexion...";
                
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                };
                await initAuth();

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('connection-status').textContent = "Connect√© (Cloud)";
                        document.getElementById('connection-status').className = "font-bold text-green-600";
                        startDataListeners();
                        fetchAdminCode(); 
                    } else {
                         document.getElementById('connection-status').textContent = "D√©connect√©";
                    }
                });
                
                document.getElementById('admin-correction-date').valueAsDate = new Date();
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                document.getElementById('admin-month-picker').value = `${yyyy}-${mm}`;

            } catch (error) {
                console.error("Erreur:", error);
                document.getElementById('connection-status').textContent = "Mode Hors Ligne";
                handleFirebaseError(error);
            }
        };

        // --- LOGO & ADMIN UTILS (Standard) ---
        function resizeAndCompressImage(file, maxWidth, quality, callback) {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = function(event) { const img = new Image(); img.src = event.target.result; img.onload = function() { const canvas = document.createElement('canvas'); let width = img.width; let height = img.height; if (width > maxWidth) { height = Math.round((height * maxWidth) / width); width = maxWidth; } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); callback(canvas.toDataURL('image/png')); }; };
        }
        window.handleLogoUpload = (input) => { const file = input.files[0]; if (!file) return; document.getElementById('logo-loading').classList.remove('hidden'); resizeAndCompressImage(file, 400, 0.7, async (b64) => { try { await setDoc(getDocRef('settings', 'branding'), { logoBase64: b64, updatedAt: serverTimestamp() }); showToast("Logo mis √† jour !"); } catch(e){} finally { document.getElementById('logo-loading').classList.add('hidden'); } }); };
        async function fetchAdminCode() { try { const d = await getDoc(getDocRef('settings', 'admin_config')); if (d.exists()) currentAdminCode = d.data().code; } catch (e) {} }
        
        function startDataListeners() {
            if (!isAuthReady) return;
            onSnapshot(getDocRef('settings', 'branding'), (doc) => { if(doc.exists() && doc.data().logoBase64) { document.getElementById('app-logo').src = doc.data().logoBase64; document.getElementById('app-logo').style.display='block'; document.getElementById('app-logo').classList.remove('hidden'); document.getElementById('fallback-logo-icon').classList.add('hidden'); } });
            onSnapshot(getColRef('employees'), (snapshot) => { employees = []; const s1 = document.getElementById('admin-correction-employee'); const s2 = document.getElementById('edit-punch-employee'); s1.innerHTML = '<option value="">-- Tous les employ√©s --</option>'; s2.innerHTML = ''; snapshot.forEach(doc => { const d = { id: doc.id, ...doc.data() }; employees.push(d); const o1 = document.createElement('option'); o1.value = d.code; o1.textContent = d.name; s1.appendChild(o1); const o2 = document.createElement('option'); o2.value = d.code; o2.textContent = d.name; s2.appendChild(o2); }); renderEmployeeTable(); });
            onSnapshot(query(getColRef('punches'), orderBy('punchInTime', 'desc')), (snapshot) => { punches = []; snapshot.forEach(doc => { punches.push({ id: doc.id, ...doc.data() }); }); loadCorrectionData(); renderMonthPreview(); });
        }
        function handleFirebaseError(error) { if (navigator.onLine === false) { document.getElementById('connection-status').textContent = "Hors ligne (Local)"; } }

        // --- EXCEL & PREVIEW (Standard) ---
        const getWeekNumber = (d) => { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1)/7); };
        function renderEmployeeRows(tbodyElement, emp, year, month) {
            if (!tbodyElement) return; tbodyElement.innerHTML = '';
            const daysInMonth = new Date(year, month, 0).getDate(); let currentWeekNum = null; let weeklyTotalMs = 0;
            const pushWeekSummary = (weekNum) => { const totalStr = formatDuration(weeklyTotalMs); const row = document.createElement('tr'); row.innerHTML = `<td class="preview-week-row">TOT SEM ${weekNum}</td><td colspan="8"></td><td class="preview-week-row">TOT HEBDO</td><td class="preview-week-row">${totalStr}</td>`; tbodyElement.appendChild(row); };
            for (let d = 1; d <= daysInMonth; d++) {
                const dateObj = new Date(year, month - 1, d); const weekNum = getWeekNumber(dateObj); const dateStr = dateObj.toLocaleDateString('fr-FR', {weekday: 'short', day: '2-digit', month: '2-digit'});
                if (currentWeekNum !== null && weekNum !== currentWeekNum) { pushWeekSummary(currentWeekNum); weeklyTotalMs = 0; } currentWeekNum = weekNum;
                const dayPunches = punches.filter(p => { if (p.employeeCode !== emp.code || !p.punchInTime) return false; const pDate = p.punchInTime.toDate(); const displayDate = new Date(pDate); if (displayDate.getHours() < 3) displayDate.setDate(displayDate.getDate() - 1); return `${displayDate.getFullYear()}-${String(displayDate.getMonth()+1).padStart(2,'0')}-${String(displayDate.getDate()).padStart(2,'0')}` === `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`; });
                dayPunches.sort((a,b) => a.punchInTime.toMillis() - b.punchInTime.toMillis());
                let arrM="", depM="", totM="", arrS="", depS="", totS="", totalDailyStr="00h 00"; let d1=0, d2=0;
                if (dayPunches.length > 0) {
                    const p1 = dayPunches[0]; arrM = p1.punchInTime.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); if (p1.punchOutTime) { depM = p1.punchOutTime.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); d1 = Math.max(0, (p1.punchOutTime.toMillis() - p1.punchInTime.toMillis()) - ((p1.breakDuration||0)*60000)); totM = formatDuration(d1); } else depM = '<span class="text-orange-500">...</span>';
                    if (dayPunches.length > 1) { const p2 = dayPunches[1]; arrS = p2.punchInTime.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); if (p2.punchOutTime) { depS = p2.punchOutTime.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); d2 = Math.max(0, (p2.punchOutTime.toMillis() - p2.punchInTime.toMillis()) - ((p2.breakDuration||0)*60000)); totS = formatDuration(d2); } else depS = '<span class="text-orange-500">...</span>'; }
                    totalDailyStr = formatDuration(d1+d2); weeklyTotalMs += (d1+d2);
                }
                const tr = document.createElement('tr'); tr.className = d % 2 === 0 ? "bg-gray-50 hover:bg-yellow-50" : "bg-white hover:bg-yellow-50";
                tr.innerHTML = `<td class="preview-cell">${weekNum}</td><td class="preview-cell font-medium">${dateStr}</td><td class="preview-cell">${arrM}</td><td class="preview-cell">${depM}</td><td class="preview-cell text-xs text-gray-400">${dayPunches[0]?.breakDuration||""}</td><td class="preview-cell font-bold">${totM}</td><td class="preview-cell">${arrS}</td><td class="preview-cell">${depS}</td><td class="preview-cell text-xs text-gray-400">${dayPunches[1]?.breakDuration||""}</td><td class="preview-cell font-bold">${totS}</td><td class="preview-cell font-bold text-blue-800">${totalDailyStr}</td>`; tbodyElement.appendChild(tr);
            }
            if (currentWeekNum !== null) pushWeekSummary(currentWeekNum);
        }
        
        // --- UPDATED EXCEL EXPORT (DECIMAL HOURS + FORMULAS + HS COLS) ---
        window.exportToExcel = () => {
            const monthPicker = document.getElementById('admin-month-picker');
            const selectedMonthVal = monthPicker.value;
            if (!selectedMonthVal) { alert("Veuillez s√©lectionner un mois."); return; }
            if (employees.length === 0 && punches.length === 0) { alert('Aucune donn√©e.'); return; }
            const [selYear, selMonth] = selectedMonthVal.split('-').map(Number);
            const daysInMonth = new Date(selYear, selMonth, 0).getDate();
            const wb = XLSX.utils.book_new();
            
            // Styles
            const headerStyle = { font: { bold: true, color: { rgb: "000000" } }, fill: { fgColor: { rgb: "FFC000" } }, alignment: { horizontal: "center" }, border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} } };
            const cellStyle = { alignment: { horizontal: "center" }, border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} } };
            // FIX: Use numFmt property for correct Excel formatting
            const timeStyle = { numFmt: 'hh:mm', alignment: { horizontal: "center" }, border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} } };
            const durationStyle = { numFmt: '[h]:mm', alignment: { horizontal: "center" }, border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} } };
            const decStyle = { numFmt: '0.00', font: { bold: true }, alignment: { horizontal: "center" }, border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} } };
            const weekSummaryStyle = { font: { bold: true, color: { rgb: "FF0000" } }, fill: { fgColor: { rgb: "FFFF00" } }, alignment: { horizontal: "center" }, border: { top: {style:'medium'}, bottom: {style:'medium'}, left: {style:'medium'}, right: {style:'medium'} } };
            
            // Helper to get Excel Time Value (fraction of day)
            const getExcelTime = (dateObj) => {
                if(!dateObj) return "";
                const h = dateObj.getHours();
                const m = dateObj.getMinutes();
                return (h / 24) + (m / 1440);
            };

            employees.forEach(emp => {
                const rows = [];
                // Header (Row 1) with HS Columns
                rows.push([
                    {v: 'N¬∞ Semaine', s: headerStyle},
                    {v: 'Date', s: headerStyle},
                    {v: 'Arriv√©e M', s: headerStyle},
                    {v: 'D√©part M', s: headerStyle},
                    {v: 'Pause M', s: headerStyle},
                    {v: 'Total M', s: headerStyle},
                    {v: 'Arriv√©e S', s: headerStyle},
                    {v: 'D√©part S', s: headerStyle},
                    {v: 'Pause S', s: headerStyle},
                    {v: 'Total S', s: headerStyle},
                    {v: 'Total Jour', s: headerStyle},
                    {v: 'HS 10%', s: headerStyle},
                    {v: 'HS 20%', s: headerStyle},
                    {v: 'HS 50%', s: headerStyle}
                ]);
                
                let currentWeekNum = null; 
                let startRowOfWeek = 2; // Data starts at row 2
                let currentRowIndex = 2; // Track current row in Excel (1-based index)

                const pushWeekSummary = (weekNum) => {
                      const endRowOfWeek = currentRowIndex - 1;
                      const kRow = currentRowIndex; // The summary row index
                      
                      // Weekly Total Formula (Col K)
                      const sumFormula = `SUM(K${startRowOfWeek}:K${endRowOfWeek})`;
                      
                      // OVERTIME FORMULAS (Based on Weekly Total in Column K)
                      // Assuming thresholds: 35h, 39h, 43h
                      // HS 10%: >35 to 39
                      const formula10 = `MAX(0, MIN(K${kRow}, 39) - 35)`;
                      // HS 20%: >39 to 43
                      const formula20 = `MAX(0, MIN(K${kRow}, 43) - 39)`;
                      // HS 50%: >43
                      const formula50 = `MAX(0, K${kRow} - 43)`;

                      rows.push([
                          {v: `TOTAL SEM ${weekNum}`, s: weekSummaryStyle},
                          {v: '', s: weekSummaryStyle},
                          {v: '', s: weekSummaryStyle},
                          {v: '', s: weekSummaryStyle},
                          {v: '', s: weekSummaryStyle},
                          {v: '', s: weekSummaryStyle},
                          {v: '', s: weekSummaryStyle},
                          {v: '', s: weekSummaryStyle},
                          {v: '', s: weekSummaryStyle},
                          {v: 'TOTAL HEBDO:', s: weekSummaryStyle},
                          {f: sumFormula, t: 'n', s: { ...weekSummaryStyle, numFmt: '0.00' }}, // K: Weekly Total
                          {f: formula10, t: 'n', s: { ...weekSummaryStyle, numFmt: '0.00' }},  // L: 10%
                          {f: formula20, t: 'n', s: { ...weekSummaryStyle, numFmt: '0.00' }},  // M: 20%
                          {f: formula50, t: 'n', s: { ...weekSummaryStyle, numFmt: '0.00' }}   // N: 50%
                      ]);
                      
                      rows.push([null]); // Empty row spacer
                      currentRowIndex += 2;
                      startRowOfWeek = currentRowIndex;
                };
                
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateObj = new Date(selYear, selMonth - 1, d); 
                    const weekNum = getWeekNumber(dateObj); 
                    const dateStr = dateObj.toLocaleDateString('fr-FR', {weekday: 'short', day: '2-digit', month: '2-digit'});
                    
                    if (currentWeekNum !== null && weekNum !== currentWeekNum) { 
                        pushWeekSummary(currentWeekNum); 
                    }
                    currentWeekNum = weekNum;
                    
                    const dayPunches = punches.filter(p => { 
                        if (p.employeeCode !== emp.code || !p.punchInTime) return false;
                        const pDate = p.punchInTime.toDate(); 
                        const displayDate = new Date(pDate);
                        if (displayDate.getHours() < 3) displayDate.setDate(displayDate.getDate() - 1);
                        const pKey = `${displayDate.getFullYear()}-${String(displayDate.getMonth()+1).padStart(2,'0')}-${String(displayDate.getDate()).padStart(2,'0')}`; 
                        const dKey = `${selYear}-${String(selMonth).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        return pKey === dKey; 
                    });
                    
                    dayPunches.sort((a,b) => a.punchInTime.toMillis() - b.punchInTime.toMillis());
                    
                    let arrMVal = "", depMVal = "", pauseMVal = 0;
                    let arrSVal = "", depSVal = "", pauseSVal = 0;
                    
                    if (dayPunches.length > 0) {
                        const p1 = dayPunches[0]; 
                        const p1In = p1.punchInTime.toDate(); 
                        const p1Out = p1.punchOutTime ? p1.punchOutTime.toDate() : null; 
                        
                        arrMVal = getExcelTime(p1In);
                        depMVal = getExcelTime(p1Out);
                        pauseMVal = p1.breakDuration || 0;
                        
                        if (dayPunches.length > 1) {
                            const p2 = dayPunches[1]; 
                            const p2In = p2.punchInTime.toDate(); 
                            const p2Out = p2.punchOutTime ? p2.punchOutTime.toDate() : null; 
                            
                            arrSVal = getExcelTime(p2In);
                            depSVal = getExcelTime(p2Out);
                            pauseSVal = p2.breakDuration || 0;
                        }
                    }

                    // EXCEL FORMULAS
                    const r = currentRowIndex;
                    // Total M (Time Format): (Dep - Arr) - (Pause_min / 1440)
                    const formulaTotalM = `IF(AND(D${r}<>"",C${r}<>""),D${r}-C${r}-(E${r}/1440),0)`;
                    // Total S (Time Format)
                    const formulaTotalS = `IF(AND(H${r}<>"",G${r}<>""),H${r}-G${r}-(I${r}/1440),0)`;
                    // Total Decimal (Number Format): (TotalM + TotalS) * 24
                    const formulaTotalDec = `(F${r}+J${r})*24`;

                    rows.push([
                        {v: weekNum, s: cellStyle},
                        {v: dateStr, s: cellStyle},
                        {v: arrMVal, t: 'n', s: timeStyle}, // C: Arrivee M (Number + Time Style)
                        {v: depMVal, t: 'n', s: timeStyle}, // D: Depart M (Number + Time Style)
                        {v: pauseMVal, t: 'n', s: cellStyle}, // E: Pause M (Integer)
                        {f: formulaTotalM, t: 'n', s: durationStyle}, // F: Total M (Duration Style)
                        {v: arrSVal, t: 'n', s: timeStyle}, // G: Arrivee S
                        {v: depSVal, t: 'n', s: timeStyle}, // H: Depart S
                        {v: pauseSVal, t: 'n', s: cellStyle}, // I: Pause S
                        {f: formulaTotalS, t: 'n', s: durationStyle}, // J: Total S
                        {f: formulaTotalDec, t: 'n', s: decStyle}, // K: Total Decimal
                        {v: '', s: cellStyle}, // L (Empty daily)
                        {v: '', s: cellStyle}, // M (Empty daily)
                        {v: '', s: cellStyle}  // N (Empty daily)
                    ]);
                    
                    currentRowIndex++;
                }
                
                if (currentWeekNum !== null) { pushWeekSummary(currentWeekNum); }
                
                const ws = XLSX.utils.aoa_to_sheet(rows); 
                ws['!cols'] = [{wch:10}, {wch:12}, {wch:12}, {wch:12}, {wch:8}, {wch:12}, {wch:12}, {wch:12}, {wch:8}, {wch:12}, {wch:15}, {wch:10}, {wch:10}, {wch:10}]; 
                XLSX.utils.book_append_sheet(wb, ws, emp.name.replace(/[*?\/\[\]]/g, '').slice(0, 25));
            });
            
            XLSX.writeFile(wb, `Pointage_Calculs_Auto_${selectedMonthVal}.xlsx`);
        };

        window.renderMonthPreview = () => { const mp = document.getElementById('admin-month-picker'); const c = document.getElementById('preview-records-container'); if(!mp.value) return; c.innerHTML = ''; const [y, m] = mp.value.split('-').map(Number); employees.forEach(emp => { const card = document.createElement('div'); card.className = "mb-8 bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden"; card.innerHTML = `<div class="bg-gray-100 px-4 py-3 border-b border-gray-200 flex justify-between items-center"><span class="font-bold text-gray-700 text-lg">${emp.name}</span><span class="text-xs font-mono bg-white px-2 py-1 rounded border">${emp.code}</span></div><div class="overflow-x-auto"><table class="min-w-full border-collapse"><thead class="bg-gray-50 border-b border-gray-200"><tr><th class="preview-header">Sem</th><th class="preview-header">Date</th><th class="preview-header">Arr M</th><th class="preview-header">Dep M</th><th class="preview-header">Pau M</th><th class="preview-header">Tot M</th><th class="preview-header">Arr S</th><th class="preview-header">Dep S</th><th class="preview-header">Pau S</th><th class="preview-header">Tot S</th><th class="preview-header">Total</th></tr></thead><tbody class="bg-white"></tbody></table></div>`; c.appendChild(card); renderEmployeeRows(card.querySelector('tbody'), emp, y, m); }); };

        // --- ADMIN HELPERS ---
        // RESTORED: Employee Table Functions
        window.deleteEmployee = async (id, name) => { if(confirm(`Supprimer l'employ√© ${name} ?`)) await deleteDoc(getDocRef('employees', id)); };

        window.renderEmployeeTable = () => { 
            const b = document.getElementById('employee-table-body'); 
            if(!b) return; 
            b.innerHTML=''; 
            employees.forEach(e=>{ 
                b.innerHTML+=`<tr class="hover:bg-gray-50"><td class="px-6 py-3 text-sm text-gray-900">${e.name}</td><td class="px-6 py-3 text-sm text-gray-500">${e.code}</td><td class="px-6 py-3 text-right"><button onclick="deleteEmployee('${e.id}','${e.name}')" class="text-red-600 hover:text-red-900 font-medium text-sm">Supprimer</button></td></tr>`; 
            }); 
        };

        // RESTORED: Employee History Function (used in Employee View)
        window.renderEmployeeHistory = () => {
            const picker = document.getElementById('employee-month-picker');
            if (!picker || !currentEmployee) return;
            
            // Default to current month if empty
            if (!picker.value) {
                const today = new Date();
                const y = today.getFullYear();
                const m = String(today.getMonth() + 1).padStart(2, '0');
                picker.value = `${y}-${m}`;
            }
            
            const [year, month] = picker.value.split('-').map(Number);
            const tbody = document.getElementById('employee-history-body');
            renderEmployeeRows(tbody, currentEmployee, year, month);
        };

        // NEW: Load Correction Data with Edit Button
        window.loadCorrectionData = () => {
            const empCode = document.getElementById('admin-correction-employee').value;
            const dateVal = document.getElementById('admin-correction-date').value;
            const tbody = document.getElementById('correction-table-body');
            tbody.innerHTML = '';
            
            if (!dateVal) return;
            const targetDateStr = new Date(dateVal).toDateString();
            
            const filteredPunches = punches.filter(p => { 
                if (!p.punchInTime) return false;
                const pDate = p.punchInTime.toDate(); 
                return pDate.toDateString() === targetDateStr && (empCode ? p.employeeCode === empCode : true); 
            });
            
            if (filteredPunches.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-2 text-sm text-gray-500 text-center italic">Aucun pointage ce jour.</td></tr>'; 
                return; 
            }
            
            filteredPunches.forEach(p => { 
                const tr = document.createElement('tr'); 
                const pi = p.punchInTime.toDate(); 
                const po = p.punchOutTime ? p.punchOutTime.toDate() : null; 
                tr.innerHTML = `
                    <td class="px-4 py-2 text-sm text-gray-900">${p.employeeName}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${pi.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${po?po.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}):'<span class="text-red-500">En cours</span>'}</td>
                    <td class="px-4 py-2 text-sm text-gray-500">${p.breakDuration||0} min</td>
                    <td class="px-4 py-2 text-right text-sm font-medium">
                        <button onclick="openManualPunchModal('${p.id}')" class="text-blue-600 hover:text-blue-900 mr-3 font-medium text-sm">Modifier</button>
                        <button onclick="deletePunch('${p.id}')" class="text-red-600 hover:text-red-900 font-medium text-sm">Supprimer</button>
                    </td>`; 
                tbody.appendChild(tr); 
            });
        };

        // NEW: Open Manual Punch Modal (Shared for New/Edit)
        window.openManualPunchModal = (punchId) => {
            const modal = document.getElementById('manual-correction-modal');
            const title = document.getElementById('correction-modal-title');
            const empSelect = document.getElementById('edit-punch-employee');
            const dateInput = document.getElementById('edit-punch-date');
            const inInput = document.getElementById('edit-punch-in');
            const outInput = document.getElementById('edit-punch-out');
            const breakInput = document.getElementById('edit-punch-break');
            const idInput = document.getElementById('edit-punch-id');
            
            let punchData = punchId ? punches.find(p => p.id === punchId) : null;
            
            if (punchData) { 
                title.textContent = "Modifier le pointage"; 
                idInput.value = punchData.id; 
                empSelect.value = punchData.employeeCode; 
                empSelect.disabled = true; 
                
                const pi = new Date(punchData.punchInTime.seconds * 1000); 
                dateInput.value = getLocalDateInputValue(pi); 
                inInput.value = pi.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false}); 
                
                if (punchData.punchOutTime) { 
                    const po = new Date(punchData.punchOutTime.seconds * 1000); 
                    outInput.value = po.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false}); 
                } else {
                    outInput.value = ''; 
                }
                breakInput.value = punchData.breakDuration || 0; 
            } else { 
                title.textContent = "Ajouter un pointage manuel"; 
                idInput.value = ""; 
                empSelect.disabled = false; 
                empSelect.value = document.getElementById('admin-correction-employee').value || (employees.length > 0 ? employees[0].code : ""); 
                dateInput.value = document.getElementById('admin-correction-date').value || getLocalDateInputValue(new Date()); 
                inInput.value = "09:00"; 
                outInput.value = "17:00"; 
                breakInput.value = 0; 
            }
            modal.classList.remove('hidden'); 
            modal.classList.add('flex');
        };

        // NEW: Save Manual Punch Logic
        window.saveManualPunch = async () => {
            const id = document.getElementById('edit-punch-id').value; 
            const empCode = document.getElementById('edit-punch-employee').value; 
            const dateStr = document.getElementById('edit-punch-date').value; 
            const inStr = document.getElementById('edit-punch-in').value; 
            const outStr = document.getElementById('edit-punch-out').value; 
            const breakVal = parseInt(document.getElementById('edit-punch-break').value) || 0;
            
            if (!empCode || !dateStr || !inStr) { alert("Champs requis manquants."); return; }
            
            const empObj = employees.find(e => e.code === empCode); 
            
            const [y, mo, d] = dateStr.split('-').map(Number);
            const [h, mi] = inStr.split(':').map(Number);
            const punchInDate = new Date(y, mo - 1, d, h, mi);
            
            let punchOutDate = null;
            if (outStr) {
                const [hOut, mOut] = outStr.split(':').map(Number);
                punchOutDate = new Date(y, mo - 1, d, hOut, mOut);
                // Handle overnight
                if (punchOutDate < punchInDate) punchOutDate.setDate(punchOutDate.getDate() + 1);
            }

            const data = { 
                employeeCode: empCode, 
                employeeName: empObj.name, 
                punchInTime: Timestamp.fromDate(punchInDate), 
                punchOutTime: punchOutDate ? Timestamp.fromDate(punchOutDate) : null, 
                breakDuration: breakVal 
            };
            
            try { 
                if (id) await updateDoc(getDocRef('punches', id), data); 
                else await addDoc(getColRef('punches'), data); 
                
                showToast("Enregistr√© !"); 
                document.getElementById('manual-correction-modal').classList.add('hidden'); 
                document.getElementById('manual-correction-modal').classList.remove('flex'); 
            } catch (e) { 
                alert("Erreur: " + e.message); 
            }
        };

        window.deletePunch = async(id) => { if(confirm("Supprimer ?")) await deleteDoc(getDocRef('punches', id)); };
        window.requestAdminAccess = () => { document.getElementById('admin-login-modal').classList.remove('hidden'); document.getElementById('admin-login-modal').classList.add('flex'); document.getElementById('admin-login-input').value=''; };
        window.closeAdminModal = () => { document.getElementById('admin-login-modal').classList.add('hidden'); document.getElementById('admin-login-modal').classList.remove('flex'); };
        window.verifyAdminCode = () => { if(document.getElementById('admin-login-input').value === currentAdminCode) { closeAdminModal(); showView('admin'); loadCorrectionData(); } else document.getElementById('admin-login-error').textContent="Erreur!"; };
        window.saveNewAdminCode = async() => { await setDoc(getDocRef('settings', 'admin_config'), {code: document.getElementById('setting-admin-code').value}); };
        window.resetAllPunches = async() => { if(confirm("RESET TOTAL ?") && prompt("Code:")===currentAdminCode) { const s=await getDocs(query(getColRef('punches'))); s.forEach(d=>deleteDoc(d.ref)); } };
        window.addEmployee = async() => { const n=document.getElementById('new-employee-name').value; const c=document.getElementById('new-employee-code').value; if(n&&c.length===4) await addDoc(getColRef('employees'), {name:n, code:c}); document.getElementById('new-employee-name').value=''; document.getElementById('new-employee-code').value=''; };

        // --- VIEW MANAGEMENT ---
        const views = { punch: document.getElementById('view-punch'), admin: document.getElementById('view-admin') };
        const tabs = { punch: document.getElementById('tab-punch'), admin: document.getElementById('tab-admin') };
        window.showView = (name) => { Object.keys(views).forEach(k => { views[k].classList.toggle('hidden', k!==name); const t = tabs[k]; const a = t.getAttribute('data-active-class').split(' '); const i = t.getAttribute('data-inactive-class').split(' '); t.classList.remove(...(k===name?i:a)); t.classList.add(...(k===name?a:i)); }); };
        showView('punch');

        let currentPunchMode = null; let currentManualEmployee = null; let currentManualPunchDoc = null;
        let selectedHour = "00"; let selectedMinute = "00";
        let tempPunchDate = null;

        // ==========================================
        //  NEW: QUARTER HOUR SCROLL WHEEL LOGIC
        // ==========================================
        const QUARTER_HOURS = ["00", "15", "30", "45"];
        
        function populateWheels() {
            const hWheel = document.getElementById('hour-wheel');
            const mWheel = document.getElementById('minute-wheel');
            
            let hHTML = ''; 
            for(let i=0; i<24; i++) {
                hHTML += `<div class="wheel-item" data-val="${String(i).padStart(2,'0')}">${String(i).padStart(2,'0')}</div>`;
            }
            
            // NEW: Only generate quarter hours
            let mHTML = '';
            QUARTER_HOURS.forEach(m => {
                 mHTML += `<div class="wheel-item" data-val="${m}">${m}</div>`;
            });
            
            hWheel.innerHTML = hHTML;
            mWheel.innerHTML = mHTML;
            
            hWheel.addEventListener('scroll', () => handleScroll(hWheel, 'h'));
            mWheel.addEventListener('scroll', () => handleScroll(mWheel, 'm'));
        }
        
        function handleScroll(el, type) {
            const itemHeight = 50; // Updated CSS height
            const index = Math.round(el.scrollTop / itemHeight);
            
            if (type === 'h') {
                const val = String(Math.min(23, Math.max(0, index))).padStart(2, '0');
                selectedHour = val;
            } else {
                // Map index to quarter hour array
                const safeIndex = Math.min(3, Math.max(0, index));
                selectedMinute = QUARTER_HOURS[safeIndex];
            }
            
            // Highlight logic
            Array.from(el.children).forEach((child, i) => {
                if (i === index) { 
                    child.style.color = '#1e293b'; // Slate 800
                    child.style.transform = 'scale(1.2)';
                } else {
                    child.style.color = '#cbd5e1'; // Slate 300
                    child.style.transform = 'scale(1)';
                }
            });
        }
        
        function scrollToTime(h, m) {
            const hWheel = document.getElementById('hour-wheel');
            const mWheel = document.getElementById('minute-wheel');
            const itemHeight = 50;
            
            // Find closest quarter hour index
            let mIndex = 0;
            // Map "07" -> "00", "22" -> "15", etc.
            const mInt = parseInt(m);
            if (mInt >= 0 && mInt < 8) mIndex = 0; // 00
            else if (mInt >= 8 && mInt < 23) mIndex = 1; // 15
            else if (mInt >= 23 && mInt < 38) mIndex = 2; // 30
            else mIndex = 3; // 45
            
            // Set scroll positions
            hWheel.scrollTop = parseInt(h) * itemHeight;
            mWheel.scrollTop = mIndex * itemHeight;
            
            selectedHour = h;
            selectedMinute = QUARTER_HOURS[mIndex];
            
            // Trigger highlight manually
            handleScroll(hWheel, 'h');
            handleScroll(mWheel, 'm');
        }

        // --- LOGIC FLOW ---
        window.verifyCodeAndShowMenu = () => {
            const code = document.getElementById('employee-code').value;
            if(code.length !== 4) return;
            const emp = employees.find(e => e.code === code);
            if(!emp) return; // Add error feedback if needed
            
            currentEmployee = emp;
            document.getElementById('dashboard-welcome').textContent = `Bonjour ${emp.name}`;
            updatePunchButtonStatus(emp.code);
            document.getElementById('step-login').classList.add('hidden');
            document.getElementById('step-dashboard').classList.remove('hidden');
        };

        async function updatePunchButtonStatus(code) {
             const btnText = document.getElementById('btn-punch-text');
             const btnSub = document.getElementById('btn-punch-sub');
             const btnIcon = document.getElementById('btn-punch-icon');
             const btnContainer = document.getElementById('btn-punch-action');
             
             try {
                const s = await getDocs(query(getColRef('punches'), where('employeeCode', '==', code)));
                const active = s.docs.filter(d => d.data().punchOutTime === null)[0];
                
                if (active) {
                    // STATUS: WORKING (Need to Clock Out)
                    btnText.textContent = "D√âPART";
                    btnSub.textContent = "Cliquez pour finir";
                    // Color Logic
                    btnContainer.className = "p-8 rounded-xl shadow-lg border-4 text-left transition-all transform active:scale-95 flex items-center justify-between group border-orange-200 bg-orange-50 hover:bg-orange-100";
                    btnIcon.className = "p-4 rounded-full mr-4 bg-orange-200 text-orange-700";
                } else {
                    // STATUS: NOT WORKING (Need to Clock In)
                    btnText.textContent = "ARRIV√âE";
                    btnSub.textContent = "Cliquez pour commencer";
                    // Color Logic
                    btnContainer.className = "p-8 rounded-xl shadow-lg border-4 text-left transition-all transform active:scale-95 flex items-center justify-between group border-green-200 bg-green-50 hover:bg-green-100";
                    btnIcon.className = "p-4 rounded-full mr-4 bg-green-200 text-green-700";
                }
             } catch(e) {}
        }

        window.onMenuPunch = () => { if (!currentEmployee) return; handlePunchLogic(currentEmployee); };
        window.onMenuHistory = () => { if (!currentEmployee) return; document.getElementById('step-dashboard').classList.add('hidden'); document.getElementById('step-history').classList.remove('hidden'); renderEmployeeHistory(); };
        window.resetToCodeEntry = () => { currentEmployee = null; document.getElementById('employee-code').value = ''; document.getElementById('step-login').classList.remove('hidden'); document.getElementById('step-dashboard').classList.add('hidden'); document.getElementById('step-history').classList.add('hidden'); };

        window.handlePunchLogic = async (emp) => {
            try {
                const s = await getDocs(query(getColRef('punches'), where('employeeCode', '==', emp.code)));
                const active = s.docs.filter(d=>d.data().punchOutTime===null).sort((a,b)=>b.data().punchInTime.toMillis()-a.data().punchInTime.toMillis())[0];
                if(active) openManualTimeModal('OUT', emp, active); else openManualTimeModal('IN', emp, null);
            } catch(e) { console.error(e); }
        };
        
        // ==========================================
        //  NEW: COLOR-CODED MODAL LOGIC
        // ==========================================
        window.openManualTimeModal = (mode, employee, punchDoc) => {
            currentPunchMode = mode; currentManualEmployee = employee; currentManualPunchDoc = punchDoc;
            const modal = document.getElementById('manual-time-modal');
            const header = document.getElementById('manual-time-header');
            const title = document.getElementById('manual-time-title');
            const sub = document.getElementById('manual-time-subtitle');
            const btnSetNow = document.getElementById('btn-set-now');
            const btnConfirm = document.getElementById('btn-confirm-time');
            
            const dateInput = document.getElementById('manual-punch-date');
            
            // Set Date Defaults (Night Shift Logic)
            const now = new Date();
            const effectiveDate = new Date(now);
            if (now.getHours() < 3) effectiveDate.setDate(effectiveDate.getDate() - 1);
            dateInput.value = getLocalDateInputValue(effectiveDate);
            
            // Set Time to Now (Rounded)
            setTimeout(() => setManualToNow(), 50);

            // APPLY COLORS & TEXT
            if (mode === 'IN') {
                // GREEN THEME
                header.className = "p-6 text-white text-center shadow-md z-20 relative bg-green-600";
                title.textContent = "ARRIV√âE";
                sub.textContent = "D√©but de journ√©e";
                btnSetNow.className = "w-full py-3 mt-4 text-sm font-bold uppercase tracking-wide rounded-lg transition-colors border-2 border-green-100 text-green-700 bg-green-50 hover:bg-green-100";
                btnConfirm.className = "flex-1 py-4 text-white rounded-lg font-bold shadow-lg transform active:scale-95 transition-all text-lg bg-green-600 hover:bg-green-700";
            } else {
                // ORANGE/RED THEME
                header.className = "p-6 text-white text-center shadow-md z-20 relative bg-orange-600";
                title.textContent = "D√âPART";
                sub.textContent = "Fin de journ√©e";
                btnSetNow.className = "w-full py-3 mt-4 text-sm font-bold uppercase tracking-wide rounded-lg transition-colors border-2 border-orange-100 text-orange-700 bg-orange-50 hover:bg-orange-100";
                btnConfirm.className = "flex-1 py-4 text-white rounded-lg font-bold shadow-lg transform active:scale-95 transition-all text-lg bg-orange-600 hover:bg-orange-700";
            }
            
            modal.classList.remove('hidden'); modal.classList.add('flex');
        };

        window.closeManualTimeModal = () => { document.getElementById('manual-time-modal').classList.add('hidden'); document.getElementById('manual-time-modal').classList.remove('flex'); currentPunchMode = null; };
        
        window.adjustBreakRed = (amount) => { const input = document.getElementById('red-punch-break'); let val = parseInt(input.value) || 0; val = Math.max(0, val + amount); input.value = val; };
        
        window.setManualToNow = () => { 
            const now = new Date(); 
            // Night shift date logic
            const effectiveDate = new Date(now);
            if (now.getHours() < 3) effectiveDate.setDate(effectiveDate.getDate() - 1);
            document.getElementById('manual-punch-date').value = getLocalDateInputValue(effectiveDate);
            
            // Round to nearest quarter logic for initial view
            const m = now.getMinutes();
            let h = now.getHours();
            let roundedM = 0;
            
            if (m < 8) roundedM = 0;
            else if (m < 23) roundedM = 15;
            else if (m < 38) roundedM = 30;
            else if (m < 53) roundedM = 45;
            else {
                roundedM = 0;
                h = (h + 1) % 24;
            }
            
            scrollToTime(String(h).padStart(2,'0'), String(roundedM).padStart(2,'0')); 
        };

        window.confirmManualPunch = async () => {
            if (!currentManualEmployee) return;
            const dateStr = document.getElementById('manual-punch-date').value;
            // Use global selected vars from scroll wheel
            const timeStr = `${selectedHour}:${selectedMinute}`;
            if (!dateStr) { alert("Date requise."); return; }
            
            const [y, mo, d] = dateStr.split('-').map(Number);
            const [h, mi] = timeStr.split(':').map(Number);
            const dateTime = new Date(y, mo - 1, d, h, mi);
            
            // Night shift adjustment
            if (h < 3) dateTime.setDate(dateTime.getDate() + 1);

            tempPunchDate = dateTime;

            try {
                if (currentPunchMode === 'IN') { 
                    const docRef = await addDoc(getColRef('punches'), { employeeCode: currentManualEmployee.code, employeeName: currentManualEmployee.name, punchInTime: Timestamp.fromDate(dateTime), punchOutTime: null, breakDuration: 0 }); 
                    closeManualTimeModal();
                    resetToCodeEntry();
                    showSuccessModal(`ARRIV√âE ENREGISTR√âE : ${timeStr}`, docRef.id); 
                }
                else if (currentPunchMode === 'OUT' && currentManualPunchDoc) { 
                    closeManualTimeModal();
                    openBreakModal();
                }
            } catch (e) { console.error(e); alert("Erreur: " + e.message); }
        };

        window.openBreakModal = () => {
            const modal = document.getElementById('break-selection-modal');
            document.getElementById('red-punch-break').value = 0;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.confirmBreak = async () => {
            const breakDuration = parseInt(document.getElementById('red-punch-break').value) || 0;
            const modal = document.getElementById('break-selection-modal');
            try {
                await updateDoc(currentManualPunchDoc.ref, { punchOutTime: Timestamp.fromDate(tempPunchDate), breakDuration: breakDuration });
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                resetToCodeEntry();
                showSuccessModal(`D√âPART ENREGISTR√â`, currentManualPunchDoc.id);
            } catch(e) { console.error(e); alert("Erreur: " + e.message); }
        };

        // Service Worker registration logic kept intact...
        if ('serviceWorker' in navigator) {
            const swContent = `
                const CACHE_NAME = 'pointage-v2';
                const urlsToCache = ['./', 'index.html', 'https://cdn.tailwindcss.com', 'https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap', 'https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js'];
                self.addEventListener('install', event => { self.skipWaiting(); event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache.map(url => new Request(url, {mode: 'no-cors'}))))); });
                self.addEventListener('fetch', event => { event.respondWith(caches.match(event.request).then(response => response || fetch(event.request))); });
            `;
            const blob = new Blob([swContent], {type: 'text/javascript'});
            window.addEventListener('load', () => { navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(e => console.log('SW Fail:', e)); });
        }
    </script>
</body>
</html>
